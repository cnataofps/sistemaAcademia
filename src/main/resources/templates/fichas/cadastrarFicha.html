<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{painel :: header}">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Cadastrar Ficha de Treino</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			font-family: 'Inter', 'Roboto', sans-serif;
			background-color: #f8f9fa;
		}

		.main-layout {
			display: flex;
			min-height: calc(100vh - 72px);
		}

		.sidebar {
			background-color: #ffffff;
			border-right: 1px solid #dee2e6;
			width: 250px;
			padding: 0;
		}

		.content-area {
			flex-grow: 1;
			padding: 2rem;
		}

		.exercise-group {
			border: 1px solid #dee2e6;
			padding: 1rem;
			margin-bottom: 1rem;
			border-radius: 8px;
			background-color: #ffffff;
			position: relative;
		}

		.remove-exercicio-btn {
			position: absolute;
			top: 8px;
			right: 8px;
		}

		.nav-tabs .nav-item {
			margin-bottom: 0.5rem;
		}

		.nav-tabs .nav-link {
			font-weight: 500;
		}

		.treino-header {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.treino-header input {
			width: auto;
			min-width: 120px;
		}

		@media (max-width: 767.98px) {
			.main-layout {
				flex-direction: column;
			}

			.sidebar {
				width: 100%;
				border-right: none;
				border-bottom: 1px solid #dee2e6;
			}
		}

		/* Modo Noturno */
		body.dark-mode {
			background-color: #121212;
			color: #e0e0e0;
		}

		body.dark-mode .sidebar {
			background-color: #1f1f1f;
			border-color: #444;
		}

		body.dark-mode .sidebar .nav-link {
			color: #ccc;
		}

		body.dark-mode .sidebar .nav-link:hover {
			background-color: #333;
			color: #0d6efd;
		}

		body.dark-mode .sidebar .nav-link.active {
			background-color: #0d6efd;
			color: white;
		}

		body.dark-mode .content-area,
		body.dark-mode .container {
			background-color: #1e1e1e;
			color: #e0e0e0;
		}

		body.dark-mode h3,
		body.dark-mode label,
		body.dark-mode th,
		body.dark-mode td,
		body.dark-mode .form-label,
		body.dark-mode .form-check-label {
			color: #e0e0e0 !important;
		}

		body.dark-mode .form-control,
		body.dark-mode .form-select {
			background-color: #2a2a2a !important;
			color: #e0e0e0 !important;
			border-color: #555 !important;
		}

		body.dark-mode .form-control::placeholder {
			color: #aaa !important;
		}

		body.dark-mode .btn-primary {
			background-color: #0d6efd !important;
			color: #fff !important;
		}

		body.dark-mode .btn-secondary {
			background-color: #6c757d !important;
			color: #fff !important;
		}

		body.dark-mode .btn-warning {
			background-color: #ffc107 !important;
			color: #212529 !important;
		}

		body.dark-mode .btn-danger {
			background-color: #dc3545 !important;
			color: #fff !important;
		}

		body.dark-mode .table {
			background-color: #2a2a2a;
			color: #e0e0e0;
		}

		body.dark-mode .table-striped>tbody>tr:nth-of-type(odd) {
			background-color: #1f1f1f;
		}

		body.dark-mode .table-light {
			background-color: #333;
			color: #e0e0e0;
		}

		body.dark-mode .alert-info {
			background-color: #2a2a2a;
			color: #e0e0e0;
			border-color: #444;
		}

		/* Transições suaves */
		.card,
		.form-control,
		.btn,
		.table,
		.alert {
			transition: background-color 0.3s ease, color 0.3s ease;
		}
	</style>
</head>

<body>
	<div th:replace="~{painel :: navbar}"></div>

	<div class="main-layout">
		<div th:replace="~{painel :: sidebar}" class="sidebar"></div>

		<div class="content-area">
			<h1>Cadastrar Ficha de Treino</h1>
			<hr>
			<div th:if="${Mensagem}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
				<span th:text="${Mensagem}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>

			<form method="POST" action="/cadastrarFicha">
				<div class="row">
					<div class="form-group col-md-6">
						<label for="objetivo">Objetivo</label>
						<input type="text" name="objetivo" class="form-control" id="objetivo" required>
					</div>
					<div class="form-group col-md-6">
						<label for="dataCriacao">Data de Criação</label>
						<input type="date" name="dataCriacao" class="form-control" id="dataCriacao" required>
					</div>
				</div>

				<div class="row mt-3">
					<div class="form-group col-md-6">
						<label for="alunoId">Aluno</label>
						<select name="alunoId" id="alunoId" class="form-control" required>
							<option value="">Selecione o aluno</option>
							<th:block th:each="aluno : ${alunos}">
								<option th:value="${aluno.id}" th:text="${aluno.nome}"></option>
							</th:block>
						</select>
					</div>
					<div class="form-group col-md-6">
						<label for="dataTroca">Data de Troca</label>
						<input type="date" name="dataTroca" class="form-control" id="dataTroca">
					</div>
				</div>

				<hr class="my-4">
				<h4 class="mb-3">Treinos</h4>

				<ul class="nav nav-tabs" id="treinoTabs" role="tablist"></ul>
				<div class="tab-content mt-3" id="treinoContent"></div>

				<button type="button" class="btn btn-outline-success mt-3" onclick="adicionarTreino()">
					<i class="bi bi-plus-circle"></i> Adicionar Treino
				</button>

				<div class="d-flex flex-wrap gap-3 mt-4">
					<button type="submit" class="btn btn-primary btn-lg">Cadastrar Ficha</button>
					<a href="/controleDeFicha" class="btn btn-outline-secondary btn-lg">Voltar</a>
				</div>
			</form>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		let treinoIndex = 0;
		let exercicioContador = {};

		function adicionarTreino() {
			const letrasUsadas = Array.from(document.querySelectorAll('#treinoTabs .nav-link'))
				.map(el => el.textContent.trim().replace('Treino ', ''));

			const alfabeto = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
			const letraLivre = alfabeto.find(letra => !letrasUsadas.includes(letra));

			if (!letraLivre) {
				alert('Limite de treinos atingido.');
				return;
			}

			const tabId = `treino-${letraLivre}`;
			const tabIndex = treinoIndex++; // ainda usamos índice para nome dos campos

			// Aba com campo editável
			const tab = document.createElement('li');
			tab.className = 'nav-item';
			tab.id = `tab-item-${tabIndex}`;
			tab.innerHTML = `
		        <div class="treino-header">
		            <input type="text" class="form-control form-control-sm" 
		                   name="treinos[${tabIndex}].nome"
		                   value="Treino ${letraLivre}" 
		                   oninput="atualizarNomeAba(${tabIndex}, this.value)" 
		                   title="Editar nome do treino" />
		            <button class="nav-link ${tabIndex === 0 ? 'active' : ''}" id="${tabId}-tab" 
		                    data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab">
		                Treino ${letraLivre}
		            </button>
		            <button type="button" class="btn btn-sm btn-danger" onclick="removerTreino(${tabIndex})" title="Excluir Treino">
		                <i class="bi bi-trash"></i>
		            </button>
		        </div>
		    `;
			document.getElementById('treinoTabs').appendChild(tab);

			// Conteúdo da aba
			const content = document.createElement('div');
			content.className = `tab-pane fade ${tabIndex === 0 ? 'show active' : ''}`;
			content.id = tabId;
			content.setAttribute('role', 'tabpanel');
			content.innerHTML = `
		        <div id="exercicios-${tabIndex}"></div>
		        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarExercicio(${tabIndex})">
		            <i class="bi bi-plus-circle"></i> Adicionar Exercício
		        </button>
		    `;
			document.getElementById('treinoContent').appendChild(content);
		}

		function atualizarNomeAba(index, novoNome) {
			const botao = document.querySelector(`#tab-item-${index} .nav-link`);
			if (botao) {
				botao.textContent = novoNome;
			}
		}

		function removerTreino(index) {
			const tabItem = document.getElementById(`tab-item-${index}`);
			if (tabItem) tabItem.remove();

			const content = document.getElementById(`treino-${index}`);
			if (content) content.remove();

			const tabs = document.querySelectorAll('#treinoTabs .nav-link');
			if (tabs.length > 0) {
				tabs[0].classList.add('active');
				const targetId = tabs[0].getAttribute('data-bs-target');
				document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
				document.querySelector(targetId).classList.add('show', 'active');
			}
		}

		function adicionarExercicio(treinoId) {
			if (!exercicioContador[treinoId]) exercicioContador[treinoId] = 0;
			const index = exercicioContador[treinoId]++;
			const container = document.getElementById(`exercicios-${treinoId}`);

			const grupo = document.createElement('div');
			grupo.className = 'exercise-group';
			grupo.id = `exercicio-${treinoId}-${index}`;
			grupo.innerHTML = `
        <button type="button" class="btn btn-sm btn-danger remove-exercicio-btn" onclick="removerExercicio(${treinoId}, ${index})" title="Remover Exercício">
          <i class="bi bi-x-circle"></i>
        </button>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label>Nome do Exercício</label>
            <input type="text" name="treinos[${treinoId}].exercicios[${index}].nome" class="form-control" required>
          </div>
          <div class="col-md-2 mb-3">
			            <label>Séries</label>
			            <input type="number" name="treinos[${treinoId}].exercicios[${index}].serie" class="form-control" required>
			          </div>
			          <div class="col-md-2 mb-3">
			            <label>Repetições</label>
			            <input type="number" name="treinos[${treinoId}].exercicios[${index}].repeticoes" class="form-control" required>
			          </div>
			          <div class="col-md-2 mb-3">
			            <label>Carga (kg)</label>
			            <input type="number" name="treinos[${treinoId}].exercicios[${index}].carga" class="form-control">
			          </div>
			          <div class="col-md-2 mb-3">
			            <label>Observação</label>
			            <input type="text" name="treinos[${treinoId}].exercicios[${index}].observacao" class="form-control">
			          </div>
			        </div>
			      `;
			container.appendChild(grupo);
		}

		function removerExercicio(treinoId, index) {
			const grupo = document.getElementById(`exercicio-${treinoId}-${index}`);
			if (grupo) grupo.remove();
		}

		// Inicializa com uma aba padrão
		window.onload = () => adicionarTreino();
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const body = document.body;
			const toggle = document.getElementById('toggleDarkMode');

			if (localStorage.getItem('modoNoturno') === 'true') {
				body.classList.add('dark-mode');
			}

			if (toggle) {
				toggle.addEventListener('click', function () {
					body.classList.toggle('dark-mode');
					localStorage.setItem('modoNoturno', body.classList.contains('dark-mode'));
				});
			}
		});
	</script>

	<!-- RODAPÉ -->
	<div th:replace="fragments/footer :: footer"></div>
</body>

</html>